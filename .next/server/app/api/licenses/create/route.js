"use strict";(()=>{var e={};e.id=356,e.ids=[356],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},7979:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>g,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>x,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{POST:()=>l});var n=r(9303),i=r(8716),o=r(670),a=r(7070),u=r(5662),c=r(4295),p=r(650);async function l(e){try{let t;let{productId:r,startTime:s,endTime:n,maxActivations:i=1,note:o}=await e.json();if(!s||!n)return a.NextResponse.json({error:"开始时间和结束时间不能为空"},{status:400});if(new Date(s)>=new Date(n))return a.NextResponse.json({error:"结束时间必须晚于开始时间"},{status:400});let l=!1;for(;!l;){t=(0,c.Lp)();let{data:e}=await u.O.from("licenses").select("id").eq("license_key",t).single();e||(l=!0)}let d=null;if(r&&r.trim()){let{data:e}=await u.O.from("products").select("id").eq("name",r.trim()).single();if(e)d=e.id;else{let{data:e,error:t}=await u.O.from("products").insert({name:r.trim(),description:`产品: ${r.trim()}`}).select().single();t?console.error("创建产品失败:",t):d=e.id}}let{data:m,error:h}=await u.O.from("licenses").insert({license_key:t,product_id:d,start_time:new Date(s).toISOString(),end_time:new Date(n).toISOString(),max_activations:parseInt(i.toString()),note:o||null,status:"active"}).select().single();if(h)return console.error("创建授权失败:",h),a.NextResponse.json({error:`创建授权失败: ${h.message}`},{status:500});let x=(0,p.H9)(e);return await u.O.from("license_logs").insert({license_id:m.id,action:"create",result:"success",detail:`创建授权码: ${m.license_key}`,operator:"admin",ip:x}),a.NextResponse.json({success:!0,data:m})}catch(e){return console.error("创建授权异常:",e),a.NextResponse.json({error:"服务器内部错误"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/licenses/create/route",pathname:"/api/licenses/create",filename:"route",bundlePath:"app/api/licenses/create/route"},resolvedPagePath:"C:\\Users\\Ad\\Desktop\\授权后台\\app\\api\\licenses\\create\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:x}=d,f="/api/licenses/create/route";function g(){return(0,o.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:h})}},4295:(e,t,r)=>{r.d(t,{Lp:()=>a,RA:()=>o});var s=r(1482),n=r.n(s);let i=process.env.JWT_SECRET||"your-super-secret-jwt-key-here-2024";function o(e,t,r="12h"){return n().sign({licenseId:e,deviceId:t},i,{expiresIn:r})}function a(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t="";for(let r=0;r<16;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}},5662:(e,t,r)=>{r.d(t,{O:()=>o});var s=r(9498);let n=process.env.SUPABASE_URL||"https://qjukpzpvbxajiawdlcxo.supabase.co",i=process.env.SUPABASE_SERVICE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdWtwenB2Ynhhamlhd2RsY3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4ODA2MjksImV4cCI6MjA3MzQ1NjYyOX0.aJMbToTrs2jypBVM_b4LsR2dgAIxXquS1huLViUgu0Y",o=(0,s.eI)(n,i,{auth:{autoRefreshToken:!1,persistSession:!1}})},650:(e,t,r)=>{function s(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip");return t?t.split(",")[0].trim():r||"unknown"}function n(e,t){let s=r(4770),n=`${e}-${t||""}-${Date.now()}`;return s.createHash("md5").update(n).digest("hex")}function i(e){return/^[A-Z0-9]{16}$/.test(e)}function o(e){return new Date(e)<new Date}r.d(t,{CH:()=>o,H9:()=>s,m$:()=>i,zW:()=>n})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,338,482],()=>r(7979));module.exports=s})();