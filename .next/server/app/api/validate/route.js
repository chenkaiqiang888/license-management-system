"use strict";(()=>{var e={};e.id=187,e.ids=[187],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},4078:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>_,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>x});var i={};r.r(i),r.d(i,{POST:()=>d});var s=r(9303),a=r(8716),n=r(670),o=r(7070),u=r(5662),l=r(4295),c=r(650);async function d(e){try{let{licenseKey:t,deviceId:r,deviceInfo:i}=await e.json();if(!t)return o.NextResponse.json({error:"授权码不能为空"},{status:400});if(!(0,c.m$)(t))return o.NextResponse.json({error:"授权码格式不正确"},{status:400});let s=r||(0,c.zW)(e.headers.get("user-agent")||"",e.headers.get("accept-language")||""),a=(0,c.H9)(e),{data:n,error:d}=await u.O.from("licenses").select("*").eq("license_key",t).single();if(d||!n)return await u.O.from("license_logs").insert({license_id:null,action:"validate",result:"fail",detail:`授权码不存在: ${t}`,operator:"client",ip:a}),o.NextResponse.json({error:"授权码不存在"},{status:404});if("active"!==n.status)return await u.O.from("license_logs").insert({license_id:n.id,action:"validate",result:"fail",detail:`授权状态异常: ${n.status}`,operator:"client",ip:a}),o.NextResponse.json({error:"授权已被撤销或过期"},{status:403});if((0,c.CH)(n.end_time))return await u.O.from("licenses").update({status:"expired",updated_at:new Date().toISOString()}).eq("id",n.id),await u.O.from("license_logs").insert({license_id:n.id,action:"expire",result:"success",detail:"授权已过期",operator:"system",ip:a}),o.NextResponse.json({error:"授权已过期"},{status:403});let{data:p}=await u.O.from("activations").select("*").eq("license_id",n.id).eq("device_id",s).is("unbound_at",null).single();if(!p){let{data:e,error:t}=await u.O.from("activations").select("id",{count:"exact"}).eq("license_id",n.id).is("unbound_at",null);if(t)return console.error("查询激活数量失败:",t),o.NextResponse.json({error:"验证失败"},{status:500});let r=e?.length||0;if(r>=n.max_activations)return await u.O.from("license_logs").insert({license_id:n.id,action:"validate",result:"fail",detail:`激活数量已达上限: ${r}/${n.max_activations}`,operator:"client",ip:a}),o.NextResponse.json({error:"激活数量已达上限"},{status:403});let{error:l}=await u.O.from("activations").insert({license_id:n.id,device_id:s,device_info:i||null});if(l)return console.error("激活设备失败:",l),o.NextResponse.json({error:"激活失败"},{status:500});await u.O.from("license_logs").insert({license_id:n.id,action:"activate",result:"success",detail:`设备激活: ${s}`,operator:"client",ip:a})}let f=(0,l.RA)(n.id,s,"12h");return await u.O.from("license_logs").insert({license_id:n.id,action:"validate",result:"success",detail:"授权验证成功",operator:"client",ip:a}),o.NextResponse.json({success:!0,data:{token:f,license:{id:n.id,license_key:n.license_key,end_time:n.end_time,max_activations:n.max_activations},device_id:s}})}catch(e){return console.error("授权验证异常:",e),o.NextResponse.json({error:"服务器内部错误"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/validate/route",pathname:"/api/validate",filename:"route",bundlePath:"app/api/validate/route"},resolvedPagePath:"C:\\Users\\Ad\\Desktop\\授权后台\\app\\api\\validate\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:f,staticGenerationAsyncStorage:x,serverHooks:m}=p,v="/api/validate/route";function _(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:x})}},4295:(e,t,r)=>{r.d(t,{Lp:()=>o,RA:()=>n});var i=r(1482),s=r.n(i);let a=process.env.JWT_SECRET||"your-super-secret-jwt-key-here-2024";function n(e,t,r="12h"){return s().sign({licenseId:e,deviceId:t},a,{expiresIn:r})}function o(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t="";for(let r=0;r<16;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}},5662:(e,t,r)=>{r.d(t,{O:()=>n});var i=r(9498);let s=process.env.SUPABASE_URL||"https://qjukpzpvbxajiawdlcxo.supabase.co",a=process.env.SUPABASE_SERVICE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqdWtwenB2Ynhhamlhd2RsY3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4ODA2MjksImV4cCI6MjA3MzQ1NjYyOX0.aJMbToTrs2jypBVM_b4LsR2dgAIxXquS1huLViUgu0Y",n=(0,i.eI)(s,a,{auth:{autoRefreshToken:!1,persistSession:!1}})},650:(e,t,r)=>{function i(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip");return t?t.split(",")[0].trim():r||"unknown"}function s(e,t){let i=r(4770),s=`${e}-${t||""}-${Date.now()}`;return i.createHash("md5").update(s).digest("hex")}function a(e){return/^[A-Z0-9]{16}$/.test(e)}function n(e){return new Date(e)<new Date}r.d(t,{CH:()=>n,H9:()=>i,m$:()=>a,zW:()=>s})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[276,338,482],()=>r(4078));module.exports=i})();